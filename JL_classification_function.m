function [classH,classP]=JL_classification_function(q,f,g,bJ,bA,tA,beta0,rJ,rA,a0,c1,c2,gamma,tJ,alpha,initvec,orig_tmax)
                                                
% This function determines whether a co-singular strategy (tJ,
% alpha) is an evolutionary repeller (class=2), a CSS (class=1) or a
% branching point (class=3). It uses the analytical conditions for
% evolutionary and strong convergence stability, in terms of the second
% derivatives of the fitness functions. 

% Set up parameter values:
eps=1e-2;

% Define trade-offs at the singular strategy and slightly above and below
% it:
aval=a0*(1-c1*(1-exp(c2*tJ))/(1-exp(c2)));
avalupH=a0*(1-c1*(1-exp(c2*(tJ+eps)))/(1-exp(c2)));
avaldownH=a0*(1-c1*(1-exp(c2*(tJ-eps)))/(1-exp(c2)));
avalupP=a0*(1-c1*(1-exp(c2*(tJ)))/(1-exp(c2)));
avaldownP=a0*(1-c1*(1-exp(c2*(tJ)))/(1-exp(c2)));

% Find the endemic equilibrium at the singular strategy and slightly above
% and below it:
[SJ,SA,IJ,IA,~]=endemic_equilibrium_function(tJ,tA,rJ,rA,g,aval,q,beta0,bJ,bA,f,alpha,gamma,initvec,orig_tmax);
[SJupH,SAupH,IJupH,IAupH,~]=endemic_equilibrium_function(tJ+eps,tA,rJ,rA,g,avalupH,q,beta0,bJ,bA,f,alpha,gamma,initvec,orig_tmax);
[SJdownH,SAdownH,IJdownH,IAdownH,~]=endemic_equilibrium_function(tJ-eps,tA,rJ,rA,g,avaldownH,q,beta0,bJ,bA,f,alpha,gamma,initvec,orig_tmax);
[SJupP,SAupP,IJupP,IAupP,~]=endemic_equilibrium_function(tJ,tA,rJ,rA,g,avalupP,q,beta0,bJ,bA,f,alpha+eps,gamma,initvec,orig_tmax);
[SJdownP,SAdownP,IJdownP,IAdownP,~]=endemic_equilibrium_function(tJ,tA,rJ,rA,g,avaldownP,q,beta0,bJ,bA,f,alpha-eps,gamma,initvec,orig_tmax);

% Estimate the second derivatives of the fitness functions:
deriv2H=- (2*a0*((c1*(exp(c2*tJ) - 1))/(exp(c2) - 1) - 1)*(q*(IA + IJ + SA + SJ) - 1)*(alpha*(bA - beta0*(IA*alpha^(1/2) + IJ*alpha^(1/2))*(rA - 1))*(bA + gamma - alpha*(tA - 1)) + alpha*beta0*gamma*(IA*alpha^(1/2) + IJ*alpha^(1/2))*(rA - 1))^2*(g*(beta0*f*(IA*alpha^(1/2) + IJ*alpha^(1/2))*(rA - 1)*(bJ + g + gamma - alpha*(tJ - 1)) - (bA + gamma - alpha*(tA - 1))*(bJ + g + gamma - alpha*(tJ - 1)) + beta0*f*(IA*alpha^(1/2) + IJ*alpha^(1/2))*(bA - beta0*(IA*alpha^(1/2) + IJ*alpha^(1/2))*(rA - 1))*(rJ - 1)) + beta0*gamma*(IA*alpha^(1/2) + IJ*alpha^(1/2))*(rJ - 1))*(bJ + g - beta0*(IA*alpha^(1/2) + IJ*alpha^(1/2))*(rJ - 1))^2)/(((bA - beta0*(IA*alpha^(1/2) + IJ*alpha^(1/2))*(rA - 1))*(bA + gamma - alpha*(tA - 1))*(bJ + g + gamma - alpha*(tJ - 1)) + beta0*gamma*(IA*alpha^(1/2) + IJ*alpha^(1/2))*(rA - 1)*(bJ + g + gamma - alpha*(tJ - 1)))*(bJ + g - beta0*(IA*alpha^(1/2) + IJ*alpha^(1/2))*(rJ - 1)) + gamma*(beta0*(IA*alpha^(1/2) + IJ*alpha^(1/2))*(bA - beta0*(IA*alpha^(1/2) + IJ*alpha^(1/2))*(rA - 1))*(rJ - 1)*(bA + gamma - alpha*(tA - 1)) + beta0^2*gamma*(IA*alpha^(1/2) + IJ*alpha^(1/2))^2*(rA - 1)*(rJ - 1)))^3 - (a0*c1*c2^2*exp(c2*tJ)*(q*(IA + IJ + SA + SJ) - 1)*(g*(beta0*f*(IA*alpha^(1/2) + IJ*alpha^(1/2))*(rA - 1)*(bJ + g + gamma - alpha*(tJ - 1)) - (bA + gamma - alpha*(tA - 1))*(bJ + g + gamma - alpha*(tJ - 1)) + beta0*f*(IA*alpha^(1/2) + IJ*alpha^(1/2))*(bA - beta0*(IA*alpha^(1/2) + IJ*alpha^(1/2))*(rA - 1))*(rJ - 1)) + beta0*gamma*(IA*alpha^(1/2) + IJ*alpha^(1/2))*(rJ - 1)))/((((bA - beta0*(IA*alpha^(1/2) + IJ*alpha^(1/2))*(rA - 1))*(bA + gamma - alpha*(tA - 1))*(bJ + g + gamma - alpha*(tJ - 1)) + beta0*gamma*(IA*alpha^(1/2) + IJ*alpha^(1/2))*(rA - 1)*(bJ + g + gamma - alpha*(tJ - 1)))*(bJ + g - beta0*(IA*alpha^(1/2) + IJ*alpha^(1/2))*(rJ - 1)) + gamma*(beta0*(IA*alpha^(1/2) + IJ*alpha^(1/2))*(bA - beta0*(IA*alpha^(1/2) + IJ*alpha^(1/2))*(rA - 1))*(rJ - 1)*(bA + gamma - alpha*(tA - 1)) + beta0^2*gamma*(IA*alpha^(1/2) + IJ*alpha^(1/2))^2*(rA - 1)*(rJ - 1)))*(exp(c2) - 1)) - (2*a0*g*(alpha*(bA + gamma - alpha*(tA - 1)) - alpha*beta0*f*(IA*alpha^(1/2) + IJ*alpha^(1/2))*(rA - 1))*((c1*(exp(c2*tJ) - 1))/(exp(c2) - 1) - 1)*(q*(IA + IJ + SA + SJ) - 1)*(alpha*(bA - beta0*(IA*alpha^(1/2) + IJ*alpha^(1/2))*(rA - 1))*(bA + gamma - alpha*(tA - 1)) + alpha*beta0*gamma*(IA*alpha^(1/2) + IJ*alpha^(1/2))*(rA - 1))*(bJ + g - beta0*(IA*alpha^(1/2) + IJ*alpha^(1/2))*(rJ - 1)))/(((bA - beta0*(IA*alpha^(1/2) + IJ*alpha^(1/2))*(rA - 1))*(bA + gamma - alpha*(tA - 1))*(bJ + g + gamma - alpha*(tJ - 1)) + beta0*gamma*(IA*alpha^(1/2) + IJ*alpha^(1/2))*(rA - 1)*(bJ + g + gamma - alpha*(tJ - 1)))*(bJ + g - beta0*(IA*alpha^(1/2) + IJ*alpha^(1/2))*(rJ - 1)) + gamma*(beta0*(IA*alpha^(1/2) + IJ*alpha^(1/2))*(bA - beta0*(IA*alpha^(1/2) + IJ*alpha^(1/2))*(rA - 1))*(rJ - 1)*(bA + gamma - alpha*(tA - 1)) + beta0^2*gamma*(IA*alpha^(1/2) + IJ*alpha^(1/2))^2*(rA - 1)*(rJ - 1)))^2 - (2*a0*c1*c2*g*exp(c2*tJ)*(alpha*(bA + gamma - alpha*(tA - 1)) - alpha*beta0*f*(IA*alpha^(1/2) + IJ*alpha^(1/2))*(rA - 1))*(q*(IA + IJ + SA + SJ) - 1))/((((bA - beta0*(IA*alpha^(1/2) + IJ*alpha^(1/2))*(rA - 1))*(bA + gamma - alpha*(tA - 1))*(bJ + g + gamma - alpha*(tJ - 1)) + beta0*gamma*(IA*alpha^(1/2) + IJ*alpha^(1/2))*(rA - 1)*(bJ + g + gamma - alpha*(tJ - 1)))*(bJ + g - beta0*(IA*alpha^(1/2) + IJ*alpha^(1/2))*(rJ - 1)) + gamma*(beta0*(IA*alpha^(1/2) + IJ*alpha^(1/2))*(bA - beta0*(IA*alpha^(1/2) + IJ*alpha^(1/2))*(rA - 1))*(rJ - 1)*(bA + gamma - alpha*(tA - 1)) + beta0^2*gamma*(IA*alpha^(1/2) + IJ*alpha^(1/2))^2*(rA - 1)*(rJ - 1)))*(exp(c2) - 1)) - (2*a0*c1*c2*exp(c2*tJ)*(q*(IA + IJ + SA + SJ) - 1)*(alpha*(bA - beta0*(IA*alpha^(1/2) + IJ*alpha^(1/2))*(rA - 1))*(bA + gamma - alpha*(tA - 1)) + alpha*beta0*gamma*(IA*alpha^(1/2) + IJ*alpha^(1/2))*(rA - 1))*(g*(beta0*f*(IA*alpha^(1/2) + IJ*alpha^(1/2))*(rA - 1)*(bJ + g + gamma - alpha*(tJ - 1)) - (bA + gamma - alpha*(tA - 1))*(bJ + g + gamma - alpha*(tJ - 1)) + beta0*f*(IA*alpha^(1/2) + IJ*alpha^(1/2))*(bA - beta0*(IA*alpha^(1/2) + IJ*alpha^(1/2))*(rA - 1))*(rJ - 1)) + beta0*gamma*(IA*alpha^(1/2) + IJ*alpha^(1/2))*(rJ - 1))*(bJ + g - beta0*(IA*alpha^(1/2) + IJ*alpha^(1/2))*(rJ - 1)))/((((bA - beta0*(IA*alpha^(1/2) + IJ*alpha^(1/2))*(rA - 1))*(bA + gamma - alpha*(tA - 1))*(bJ + g + gamma - alpha*(tJ - 1)) + beta0*gamma*(IA*alpha^(1/2) + IJ*alpha^(1/2))*(rA - 1)*(bJ + g + gamma - alpha*(tJ - 1)))*(bJ + g - beta0*(IA*alpha^(1/2) + IJ*alpha^(1/2))*(rJ - 1)) + gamma*(beta0*(IA*alpha^(1/2) + IJ*alpha^(1/2))*(bA - beta0*(IA*alpha^(1/2) + IJ*alpha^(1/2))*(rA - 1))*(rJ - 1)*(bA + gamma - alpha*(tA - 1)) + beta0^2*gamma*(IA*alpha^(1/2) + IJ*alpha^(1/2))^2*(rA - 1)*(rJ - 1)))^2*(exp(c2) - 1));
deriv2P=(SJ*beta0*(rJ - 1)*(g/(4*alpha^(3/2)) + (bA + gamma - alpha*(tA - 1))/(4*alpha^(3/2)) + (tA - 1)/alpha^(1/2)) + (SA*beta0*(rA - 1)*(tJ - 1))/alpha^(1/2) + (SA*beta0*(rA - 1)*(bJ + g + gamma - alpha*(tJ - 1)))/(4*alpha^(3/2)))/((bA + gamma - alpha*(tA - 1))*(bJ + g + gamma - alpha*(tJ - 1))) - (2*(tA - 1)^2*(SJ*beta0*(alpha^(1/2)*g + alpha^(1/2)*(bA + gamma - alpha*(tA - 1)))*(rJ - 1) + SA*alpha^(1/2)*beta0*(rA - 1)*(bJ + g + gamma - alpha*(tJ - 1))))/((bA + gamma - alpha*(tA - 1))^3*(bJ + g + gamma - alpha*(tJ - 1))) - (2*(tJ - 1)^2*(SJ*beta0*(alpha^(1/2)*g + alpha^(1/2)*(bA + gamma - alpha*(tA - 1)))*(rJ - 1) + SA*alpha^(1/2)*beta0*(rA - 1)*(bJ + g + gamma - alpha*(tJ - 1))))/((bA + gamma - alpha*(tA - 1))*(bJ + g + gamma - alpha*(tJ - 1))^3) - (2*(tA - 1)*(SJ*beta0*(rJ - 1)*(g/(2*alpha^(1/2)) + (bA + gamma - alpha*(tA - 1))/(2*alpha^(1/2)) - alpha^(1/2)*(tA - 1)) - SA*alpha^(1/2)*beta0*(rA - 1)*(tJ - 1) + (SA*beta0*(rA - 1)*(bJ + g + gamma - alpha*(tJ - 1)))/(2*alpha^(1/2))))/((bA + gamma - alpha*(tA - 1))^2*(bJ + g + gamma - alpha*(tJ - 1))) - (2*(tJ - 1)*(SJ*beta0*(rJ - 1)*(g/(2*alpha^(1/2)) + (bA + gamma - alpha*(tA - 1))/(2*alpha^(1/2)) - alpha^(1/2)*(tA - 1)) - SA*alpha^(1/2)*beta0*(rA - 1)*(tJ - 1) + (SA*beta0*(rA - 1)*(bJ + g + gamma - alpha*(tJ - 1)))/(2*alpha^(1/2))))/((bA + gamma - alpha*(tA - 1))*(bJ + g + gamma - alpha*(tJ - 1))^2) - (2*(tA - 1)*(tJ - 1)*(SJ*beta0*(alpha^(1/2)*g + alpha^(1/2)*(bA + gamma - alpha*(tA - 1)))*(rJ - 1) + SA*alpha^(1/2)*beta0*(rA - 1)*(bJ + g + gamma - alpha*(tJ - 1))))/((bA + gamma - alpha*(tA - 1))^2*(bJ + g + gamma - alpha*(tJ - 1))^2);

cderivH1=((a0*g*(alpha*(bA + gamma - alpha*(tA - 1)) - alpha*beta0*f*(IAdownH*alpha^(1/2) + IJdownH*alpha^(1/2))*(rA - 1))*((c1*(exp(c2*tJ) - 1))/(exp(c2) - 1) - 1)*(q*(IAdownH + IJdownH + SAdownH + SJdownH) - 1))/(((bA - beta0*(IAdownH*alpha^(1/2) + IJdownH*alpha^(1/2))*(rA - 1))*(bA + gamma - alpha*(tA - 1))*(bJ + g + gamma - alpha*(tJ - 1)) + beta0*gamma*(IAdownH*alpha^(1/2) + IJdownH*alpha^(1/2))*(rA - 1)*(bJ + g + gamma - alpha*(tJ - 1)))*(bJ + g - beta0*(IAdownH*alpha^(1/2) + IJdownH*alpha^(1/2))*(rJ - 1)) + gamma*(beta0*(IAdownH*alpha^(1/2) + IJdownH*alpha^(1/2))*(bA - beta0*(IAdownH*alpha^(1/2) + IJdownH*alpha^(1/2))*(rA - 1))*(rJ - 1)*(bA + gamma - alpha*(tA - 1)) + beta0^2*gamma*(IAdownH*alpha^(1/2) + IJdownH*alpha^(1/2))^2*(rA - 1)*(rJ - 1))) - (a0*g*(alpha*(bA + gamma - alpha*(tA - 1)) - alpha*beta0*f*(IAupH*alpha^(1/2) + IJupH*alpha^(1/2))*(rA - 1))*((c1*(exp(c2*tJ) - 1))/(exp(c2) - 1) - 1)*(q*(IAupH + IJupH + SAupH + SJupH) - 1))/(((bA - beta0*(IAupH*alpha^(1/2) + IJupH*alpha^(1/2))*(rA - 1))*(bA + gamma - alpha*(tA - 1))*(bJ + g + gamma - alpha*(tJ - 1)) + beta0*gamma*(IAupH*alpha^(1/2) + IJupH*alpha^(1/2))*(rA - 1)*(bJ + g + gamma - alpha*(tJ - 1)))*(bJ + g - beta0*(IAupH*alpha^(1/2) + IJupH*alpha^(1/2))*(rJ - 1)) + gamma*(beta0*(IAupH*alpha^(1/2) + IJupH*alpha^(1/2))*(bA - beta0*(IAupH*alpha^(1/2) + IJupH*alpha^(1/2))*(rA - 1))*(rJ - 1)*(bA + gamma - alpha*(tA - 1)) + beta0^2*gamma*(IAupH*alpha^(1/2) + IJupH*alpha^(1/2))^2*(rA - 1)*(rJ - 1))) + (a0*((c1*(exp(c2*tJ) - 1))/(exp(c2) - 1) - 1)*(q*(IAdownH + IJdownH + SAdownH + SJdownH) - 1)*(alpha*(bA - beta0*(IAdownH*alpha^(1/2) + IJdownH*alpha^(1/2))*(rA - 1))*(bA + gamma - alpha*(tA - 1)) + alpha*beta0*gamma*(IAdownH*alpha^(1/2) + IJdownH*alpha^(1/2))*(rA - 1))*(g*(beta0*f*(IAdownH*alpha^(1/2) + IJdownH*alpha^(1/2))*(rA - 1)*(bJ + g + gamma - alpha*(tJ - 1)) - (bA + gamma - alpha*(tA - 1))*(bJ + g + gamma - alpha*(tJ - 1)) + beta0*f*(IAdownH*alpha^(1/2) + IJdownH*alpha^(1/2))*(bA - beta0*(IAdownH*alpha^(1/2) + IJdownH*alpha^(1/2))*(rA - 1))*(rJ - 1)) + beta0*gamma*(IAdownH*alpha^(1/2) + IJdownH*alpha^(1/2))*(rJ - 1))*(bJ + g - beta0*(IAdownH*alpha^(1/2) + IJdownH*alpha^(1/2))*(rJ - 1)))/(((bA - beta0*(IAdownH*alpha^(1/2) + IJdownH*alpha^(1/2))*(rA - 1))*(bA + gamma - alpha*(tA - 1))*(bJ + g + gamma - alpha*(tJ - 1)) + beta0*gamma*(IAdownH*alpha^(1/2) + IJdownH*alpha^(1/2))*(rA - 1)*(bJ + g + gamma - alpha*(tJ - 1)))*(bJ + g - beta0*(IAdownH*alpha^(1/2) + IJdownH*alpha^(1/2))*(rJ - 1)) + gamma*(beta0*(IAdownH*alpha^(1/2) + IJdownH*alpha^(1/2))*(bA - beta0*(IAdownH*alpha^(1/2) + IJdownH*alpha^(1/2))*(rA - 1))*(rJ - 1)*(bA + gamma - alpha*(tA - 1)) + beta0^2*gamma*(IAdownH*alpha^(1/2) + IJdownH*alpha^(1/2))^2*(rA - 1)*(rJ - 1)))^2 - (a0*((c1*(exp(c2*tJ) - 1))/(exp(c2) - 1) - 1)*(q*(IAupH + IJupH + SAupH + SJupH) - 1)*(alpha*(bA - beta0*(IAupH*alpha^(1/2) + IJupH*alpha^(1/2))*(rA - 1))*(bA + gamma - alpha*(tA - 1)) + alpha*beta0*gamma*(IAupH*alpha^(1/2) + IJupH*alpha^(1/2))*(rA - 1))*(g*(beta0*f*(IAupH*alpha^(1/2) + IJupH*alpha^(1/2))*(rA - 1)*(bJ + g + gamma - alpha*(tJ - 1)) - (bA + gamma - alpha*(tA - 1))*(bJ + g + gamma - alpha*(tJ - 1)) + beta0*f*(IAupH*alpha^(1/2) + IJupH*alpha^(1/2))*(bA - beta0*(IAupH*alpha^(1/2) + IJupH*alpha^(1/2))*(rA - 1))*(rJ - 1)) + beta0*gamma*(IAupH*alpha^(1/2) + IJupH*alpha^(1/2))*(rJ - 1))*(bJ + g - beta0*(IAupH*alpha^(1/2) + IJupH*alpha^(1/2))*(rJ - 1)))/(((bA - beta0*(IAupH*alpha^(1/2) + IJupH*alpha^(1/2))*(rA - 1))*(bA + gamma - alpha*(tA - 1))*(bJ + g + gamma - alpha*(tJ - 1)) + beta0*gamma*(IAupH*alpha^(1/2) + IJupH*alpha^(1/2))*(rA - 1)*(bJ + g + gamma - alpha*(tJ - 1)))*(bJ + g - beta0*(IAupH*alpha^(1/2) + IJupH*alpha^(1/2))*(rJ - 1)) + gamma*(beta0*(IAupH*alpha^(1/2) + IJupH*alpha^(1/2))*(bA - beta0*(IAupH*alpha^(1/2) + IJupH*alpha^(1/2))*(rA - 1))*(rJ - 1)*(bA + gamma - alpha*(tA - 1)) + beta0^2*gamma*(IAupH*alpha^(1/2) + IJupH*alpha^(1/2))^2*(rA - 1)*(rJ - 1)))^2 + (a0*c1*c2*exp(c2*tJ)*(q*(IAdownH + IJdownH + SAdownH + SJdownH) - 1)*(g*(beta0*f*(IAdownH*alpha^(1/2) + IJdownH*alpha^(1/2))*(rA - 1)*(bJ + g + gamma - alpha*(tJ - 1)) - (bA + gamma - alpha*(tA - 1))*(bJ + g + gamma - alpha*(tJ - 1)) + beta0*f*(IAdownH*alpha^(1/2) + IJdownH*alpha^(1/2))*(bA - beta0*(IAdownH*alpha^(1/2) + IJdownH*alpha^(1/2))*(rA - 1))*(rJ - 1)) + beta0*gamma*(IAdownH*alpha^(1/2) + IJdownH*alpha^(1/2))*(rJ - 1)))/((((bA - beta0*(IAdownH*alpha^(1/2) + IJdownH*alpha^(1/2))*(rA - 1))*(bA + gamma - alpha*(tA - 1))*(bJ + g + gamma - alpha*(tJ - 1)) + beta0*gamma*(IAdownH*alpha^(1/2) + IJdownH*alpha^(1/2))*(rA - 1)*(bJ + g + gamma - alpha*(tJ - 1)))*(bJ + g - beta0*(IAdownH*alpha^(1/2) + IJdownH*alpha^(1/2))*(rJ - 1)) + gamma*(beta0*(IAdownH*alpha^(1/2) + IJdownH*alpha^(1/2))*(bA - beta0*(IAdownH*alpha^(1/2) + IJdownH*alpha^(1/2))*(rA - 1))*(rJ - 1)*(bA + gamma - alpha*(tA - 1)) + beta0^2*gamma*(IAdownH*alpha^(1/2) + IJdownH*alpha^(1/2))^2*(rA - 1)*(rJ - 1)))*(exp(c2) - 1)) - (a0*c1*c2*exp(c2*tJ)*(q*(IAupH + IJupH + SAupH + SJupH) - 1)*(g*(beta0*f*(IAupH*alpha^(1/2) + IJupH*alpha^(1/2))*(rA - 1)*(bJ + g + gamma - alpha*(tJ - 1)) - (bA + gamma - alpha*(tA - 1))*(bJ + g + gamma - alpha*(tJ - 1)) + beta0*f*(IAupH*alpha^(1/2) + IJupH*alpha^(1/2))*(bA - beta0*(IAupH*alpha^(1/2) + IJupH*alpha^(1/2))*(rA - 1))*(rJ - 1)) + beta0*gamma*(IAupH*alpha^(1/2) + IJupH*alpha^(1/2))*(rJ - 1)))/((((bA - beta0*(IAupH*alpha^(1/2) + IJupH*alpha^(1/2))*(rA - 1))*(bA + gamma - alpha*(tA - 1))*(bJ + g + gamma - alpha*(tJ - 1)) + beta0*gamma*(IAupH*alpha^(1/2) + IJupH*alpha^(1/2))*(rA - 1)*(bJ + g + gamma - alpha*(tJ - 1)))*(bJ + g - beta0*(IAupH*alpha^(1/2) + IJupH*alpha^(1/2))*(rJ - 1)) + gamma*(beta0*(IAupH*alpha^(1/2) + IJupH*alpha^(1/2))*(bA - beta0*(IAupH*alpha^(1/2) + IJupH*alpha^(1/2))*(rA - 1))*(rJ - 1)*(bA + gamma - alpha*(tA - 1)) + beta0^2*gamma*(IAupH*alpha^(1/2) + IJupH*alpha^(1/2))^2*(rA - 1)*(rJ - 1)))*(exp(c2) - 1)))/(2*eps);
cderivH2=((a0*g*((alpha - eps)*(bA + gamma - (alpha - eps)*(tA - 1)) - beta0*f*(IAdownP*(alpha - eps)^(1/2) + IJdownP*(alpha - eps)^(1/2))*(alpha - eps)*(rA - 1))*((c1*(exp(c2*tJ) - 1))/(exp(c2) - 1) - 1)*(q*(IAdownP + IJdownP + SAdownP + SJdownP) - 1))/(((bA - beta0*(IAdownP*(alpha - eps)^(1/2) + IJdownP*(alpha - eps)^(1/2))*(rA - 1))*(bA + gamma - (alpha - eps)*(tA - 1))*(bJ + g + gamma - (alpha - eps)*(tJ - 1)) + beta0*gamma*(IAdownP*(alpha - eps)^(1/2) + IJdownP*(alpha - eps)^(1/2))*(rA - 1)*(bJ + g + gamma - (alpha - eps)*(tJ - 1)))*(bJ + g - beta0*(IAdownP*(alpha - eps)^(1/2) + IJdownP*(alpha - eps)^(1/2))*(rJ - 1)) + gamma*(beta0^2*gamma*(IAdownP*(alpha - eps)^(1/2) + IJdownP*(alpha - eps)^(1/2))^2*(rA - 1)*(rJ - 1) + beta0*(IAdownP*(alpha - eps)^(1/2) + IJdownP*(alpha - eps)^(1/2))*(bA - beta0*(IAdownP*(alpha - eps)^(1/2) + IJdownP*(alpha - eps)^(1/2))*(rA - 1))*(rJ - 1)*(bA + gamma - (alpha - eps)*(tA - 1)))) - (a0*g*((alpha + eps)*(bA + gamma - (alpha + eps)*(tA - 1)) - beta0*f*(alpha + eps)*(IAupP*(alpha + eps)^(1/2) + IJupP*(alpha + eps)^(1/2))*(rA - 1))*((c1*(exp(c2*tJ) - 1))/(exp(c2) - 1) - 1)*(q*(IAupP + IJupP + SAupP + SJupP) - 1))/(gamma*(beta0^2*gamma*(IAupP*(alpha + eps)^(1/2) + IJupP*(alpha + eps)^(1/2))^2*(rA - 1)*(rJ - 1) + beta0*(bA - beta0*(IAupP*(alpha + eps)^(1/2) + IJupP*(alpha + eps)^(1/2))*(rA - 1))*(IAupP*(alpha + eps)^(1/2) + IJupP*(alpha + eps)^(1/2))*(rJ - 1)*(bA + gamma - (alpha + eps)*(tA - 1))) + ((bA - beta0*(IAupP*(alpha + eps)^(1/2) + IJupP*(alpha + eps)^(1/2))*(rA - 1))*(bA + gamma - (alpha + eps)*(tA - 1))*(bJ + g + gamma - (alpha + eps)*(tJ - 1)) + beta0*gamma*(IAupP*(alpha + eps)^(1/2) + IJupP*(alpha + eps)^(1/2))*(rA - 1)*(bJ + g + gamma - (alpha + eps)*(tJ - 1)))*(bJ + g - beta0*(IAupP*(alpha + eps)^(1/2) + IJupP*(alpha + eps)^(1/2))*(rJ - 1))) - (a0*((bA - beta0*(IAupP*(alpha + eps)^(1/2) + IJupP*(alpha + eps)^(1/2))*(rA - 1))*(alpha + eps)*(bA + gamma - (alpha + eps)*(tA - 1)) + beta0*gamma*(alpha + eps)*(IAupP*(alpha + eps)^(1/2) + IJupP*(alpha + eps)^(1/2))*(rA - 1))*(g*(beta0*f*(IAupP*(alpha + eps)^(1/2) + IJupP*(alpha + eps)^(1/2))*(rA - 1)*(bJ + g + gamma - (alpha + eps)*(tJ - 1)) - (bA + gamma - (alpha + eps)*(tA - 1))*(bJ + g + gamma - (alpha + eps)*(tJ - 1)) + beta0*f*(bA - beta0*(IAupP*(alpha + eps)^(1/2) + IJupP*(alpha + eps)^(1/2))*(rA - 1))*(IAupP*(alpha + eps)^(1/2) + IJupP*(alpha + eps)^(1/2))*(rJ - 1)) + beta0*gamma*(IAupP*(alpha + eps)^(1/2) + IJupP*(alpha + eps)^(1/2))*(rJ - 1))*((c1*(exp(c2*tJ) - 1))/(exp(c2) - 1) - 1)*(q*(IAupP + IJupP + SAupP + SJupP) - 1)*(bJ + g - beta0*(IAupP*(alpha + eps)^(1/2) + IJupP*(alpha + eps)^(1/2))*(rJ - 1)))/(gamma*(beta0^2*gamma*(IAupP*(alpha + eps)^(1/2) + IJupP*(alpha + eps)^(1/2))^2*(rA - 1)*(rJ - 1) + beta0*(bA - beta0*(IAupP*(alpha + eps)^(1/2) + IJupP*(alpha + eps)^(1/2))*(rA - 1))*(IAupP*(alpha + eps)^(1/2) + IJupP*(alpha + eps)^(1/2))*(rJ - 1)*(bA + gamma - (alpha + eps)*(tA - 1))) + ((bA - beta0*(IAupP*(alpha + eps)^(1/2) + IJupP*(alpha + eps)^(1/2))*(rA - 1))*(bA + gamma - (alpha + eps)*(tA - 1))*(bJ + g + gamma - (alpha + eps)*(tJ - 1)) + beta0*gamma*(IAupP*(alpha + eps)^(1/2) + IJupP*(alpha + eps)^(1/2))*(rA - 1)*(bJ + g + gamma - (alpha + eps)*(tJ - 1)))*(bJ + g - beta0*(IAupP*(alpha + eps)^(1/2) + IJupP*(alpha + eps)^(1/2))*(rJ - 1)))^2 + (a0*(g*(beta0*f*(IAdownP*(alpha - eps)^(1/2) + IJdownP*(alpha - eps)^(1/2))*(bA - beta0*(IAdownP*(alpha - eps)^(1/2) + IJdownP*(alpha - eps)^(1/2))*(rA - 1))*(rJ - 1) - (bA + gamma - (alpha - eps)*(tA - 1))*(bJ + g + gamma - (alpha - eps)*(tJ - 1)) + beta0*f*(IAdownP*(alpha - eps)^(1/2) + IJdownP*(alpha - eps)^(1/2))*(rA - 1)*(bJ + g + gamma - (alpha - eps)*(tJ - 1))) + beta0*gamma*(IAdownP*(alpha - eps)^(1/2) + IJdownP*(alpha - eps)^(1/2))*(rJ - 1))*((c1*(exp(c2*tJ) - 1))/(exp(c2) - 1) - 1)*(q*(IAdownP + IJdownP + SAdownP + SJdownP) - 1)*((alpha - eps)*(bA - beta0*(IAdownP*(alpha - eps)^(1/2) + IJdownP*(alpha - eps)^(1/2))*(rA - 1))*(bA + gamma - (alpha - eps)*(tA - 1)) + beta0*gamma*(IAdownP*(alpha - eps)^(1/2) + IJdownP*(alpha - eps)^(1/2))*(alpha - eps)*(rA - 1))*(bJ + g - beta0*(IAdownP*(alpha - eps)^(1/2) + IJdownP*(alpha - eps)^(1/2))*(rJ - 1)))/(((bA - beta0*(IAdownP*(alpha - eps)^(1/2) + IJdownP*(alpha - eps)^(1/2))*(rA - 1))*(bA + gamma - (alpha - eps)*(tA - 1))*(bJ + g + gamma - (alpha - eps)*(tJ - 1)) + beta0*gamma*(IAdownP*(alpha - eps)^(1/2) + IJdownP*(alpha - eps)^(1/2))*(rA - 1)*(bJ + g + gamma - (alpha - eps)*(tJ - 1)))*(bJ + g - beta0*(IAdownP*(alpha - eps)^(1/2) + IJdownP*(alpha - eps)^(1/2))*(rJ - 1)) + gamma*(beta0^2*gamma*(IAdownP*(alpha - eps)^(1/2) + IJdownP*(alpha - eps)^(1/2))^2*(rA - 1)*(rJ - 1) + beta0*(IAdownP*(alpha - eps)^(1/2) + IJdownP*(alpha - eps)^(1/2))*(bA - beta0*(IAdownP*(alpha - eps)^(1/2) + IJdownP*(alpha - eps)^(1/2))*(rA - 1))*(rJ - 1)*(bA + gamma - (alpha - eps)*(tA - 1))))^2 - (a0*c1*c2*exp(c2*tJ)*(g*(beta0*f*(IAupP*(alpha + eps)^(1/2) + IJupP*(alpha + eps)^(1/2))*(rA - 1)*(bJ + g + gamma - (alpha + eps)*(tJ - 1)) - (bA + gamma - (alpha + eps)*(tA - 1))*(bJ + g + gamma - (alpha + eps)*(tJ - 1)) + beta0*f*(bA - beta0*(IAupP*(alpha + eps)^(1/2) + IJupP*(alpha + eps)^(1/2))*(rA - 1))*(IAupP*(alpha + eps)^(1/2) + IJupP*(alpha + eps)^(1/2))*(rJ - 1)) + beta0*gamma*(IAupP*(alpha + eps)^(1/2) + IJupP*(alpha + eps)^(1/2))*(rJ - 1))*(q*(IAupP + IJupP + SAupP + SJupP) - 1))/((exp(c2) - 1)*(gamma*(beta0^2*gamma*(IAupP*(alpha + eps)^(1/2) + IJupP*(alpha + eps)^(1/2))^2*(rA - 1)*(rJ - 1) + beta0*(bA - beta0*(IAupP*(alpha + eps)^(1/2) + IJupP*(alpha + eps)^(1/2))*(rA - 1))*(IAupP*(alpha + eps)^(1/2) + IJupP*(alpha + eps)^(1/2))*(rJ - 1)*(bA + gamma - (alpha + eps)*(tA - 1))) + ((bA - beta0*(IAupP*(alpha + eps)^(1/2) + IJupP*(alpha + eps)^(1/2))*(rA - 1))*(bA + gamma - (alpha + eps)*(tA - 1))*(bJ + g + gamma - (alpha + eps)*(tJ - 1)) + beta0*gamma*(IAupP*(alpha + eps)^(1/2) + IJupP*(alpha + eps)^(1/2))*(rA - 1)*(bJ + g + gamma - (alpha + eps)*(tJ - 1)))*(bJ + g - beta0*(IAupP*(alpha + eps)^(1/2) + IJupP*(alpha + eps)^(1/2))*(rJ - 1)))) + (a0*c1*c2*exp(c2*tJ)*(g*(beta0*f*(IAdownP*(alpha - eps)^(1/2) + IJdownP*(alpha - eps)^(1/2))*(bA - beta0*(IAdownP*(alpha - eps)^(1/2) + IJdownP*(alpha - eps)^(1/2))*(rA - 1))*(rJ - 1) - (bA + gamma - (alpha - eps)*(tA - 1))*(bJ + g + gamma - (alpha - eps)*(tJ - 1)) + beta0*f*(IAdownP*(alpha - eps)^(1/2) + IJdownP*(alpha - eps)^(1/2))*(rA - 1)*(bJ + g + gamma - (alpha - eps)*(tJ - 1))) + beta0*gamma*(IAdownP*(alpha - eps)^(1/2) + IJdownP*(alpha - eps)^(1/2))*(rJ - 1))*(q*(IAdownP + IJdownP + SAdownP + SJdownP) - 1))/((exp(c2) - 1)*(((bA - beta0*(IAdownP*(alpha - eps)^(1/2) + IJdownP*(alpha - eps)^(1/2))*(rA - 1))*(bA + gamma - (alpha - eps)*(tA - 1))*(bJ + g + gamma - (alpha - eps)*(tJ - 1)) + beta0*gamma*(IAdownP*(alpha - eps)^(1/2) + IJdownP*(alpha - eps)^(1/2))*(rA - 1)*(bJ + g + gamma - (alpha - eps)*(tJ - 1)))*(bJ + g - beta0*(IAdownP*(alpha - eps)^(1/2) + IJdownP*(alpha - eps)^(1/2))*(rJ - 1)) + gamma*(beta0^2*gamma*(IAdownP*(alpha - eps)^(1/2) + IJdownP*(alpha - eps)^(1/2))^2*(rA - 1)*(rJ - 1) + beta0*(IAdownP*(alpha - eps)^(1/2) + IJdownP*(alpha - eps)^(1/2))*(bA - beta0*(IAdownP*(alpha - eps)^(1/2) + IJdownP*(alpha - eps)^(1/2))*(rA - 1))*(rJ - 1)*(bA + gamma - (alpha - eps)*(tA - 1))))))/(2*eps);
cderivP1=((SJdownP*beta0*(rJ - 1)*(g/(2*alpha^(1/2)) + (bA + gamma - alpha*(tA - 1))/(2*alpha^(1/2)) - alpha^(1/2)*(tA - 1)) - SAdownP*alpha^(1/2)*beta0*(rA - 1)*(tJ - 1) + (SAdownP*beta0*(rA - 1)*(bJ + g + gamma - alpha*(tJ - 1)))/(2*alpha^(1/2)))/((bA + gamma - alpha*(tA - 1))*(bJ + g + gamma - alpha*(tJ - 1))) - (SJupP*beta0*(rJ - 1)*(g/(2*alpha^(1/2)) + (bA + gamma - alpha*(tA - 1))/(2*alpha^(1/2)) - alpha^(1/2)*(tA - 1)) - SAupP*alpha^(1/2)*beta0*(rA - 1)*(tJ - 1) + (SAupP*beta0*(rA - 1)*(bJ + g + gamma - alpha*(tJ - 1)))/(2*alpha^(1/2)))/((bA + gamma - alpha*(tA - 1))*(bJ + g + gamma - alpha*(tJ - 1))) + ((tA - 1)*(SJdownP*beta0*(alpha^(1/2)*g + alpha^(1/2)*(bA + gamma - alpha*(tA - 1)))*(rJ - 1) + SAdownP*alpha^(1/2)*beta0*(rA - 1)*(bJ + g + gamma - alpha*(tJ - 1))))/((bA + gamma - alpha*(tA - 1))^2*(bJ + g + gamma - alpha*(tJ - 1))) - ((tA - 1)*(SJupP*beta0*(alpha^(1/2)*g + alpha^(1/2)*(bA + gamma - alpha*(tA - 1)))*(rJ - 1) + SAupP*alpha^(1/2)*beta0*(rA - 1)*(bJ + g + gamma - alpha*(tJ - 1))))/((bA + gamma - alpha*(tA - 1))^2*(bJ + g + gamma - alpha*(tJ - 1))) + ((tJ - 1)*(SJdownP*beta0*(alpha^(1/2)*g + alpha^(1/2)*(bA + gamma - alpha*(tA - 1)))*(rJ - 1) + SAdownP*alpha^(1/2)*beta0*(rA - 1)*(bJ + g + gamma - alpha*(tJ - 1))))/((bA + gamma - alpha*(tA - 1))*(bJ + g + gamma - alpha*(tJ - 1))^2) - ((tJ - 1)*(SJupP*beta0*(alpha^(1/2)*g + alpha^(1/2)*(bA + gamma - alpha*(tA - 1)))*(rJ - 1) + SAupP*alpha^(1/2)*beta0*(rA - 1)*(bJ + g + gamma - alpha*(tJ - 1))))/((bA + gamma - alpha*(tA - 1))*(bJ + g + gamma - alpha*(tJ - 1))^2))/(2*eps);
cderivP2=-((SJupH*beta0*(rJ - 1)*(g/(2*alpha^(1/2)) + (bA + gamma - alpha*(tA - 1))/(2*alpha^(1/2)) - alpha^(1/2)*(tA - 1)) + (SAupH*beta0*(rA - 1)*(bJ + g + gamma - alpha*(eps + tJ - 1)))/(2*alpha^(1/2)) - SAupH*alpha^(1/2)*beta0*(rA - 1)*(eps + tJ - 1))/((bA + gamma - alpha*(tA - 1))*(bJ + g + gamma - alpha*(eps + tJ - 1))) - (SJdownH*beta0*(rJ - 1)*(g/(2*alpha^(1/2)) + (bA + gamma - alpha*(tA - 1))/(2*alpha^(1/2)) - alpha^(1/2)*(tA - 1)) + SAdownH*alpha^(1/2)*beta0*(rA - 1)*(eps - tJ + 1) + (SAdownH*beta0*(rA - 1)*(bJ + g + gamma + alpha*(eps - tJ + 1)))/(2*alpha^(1/2)))/((bA + gamma - alpha*(tA - 1))*(bJ + g + gamma + alpha*(eps - tJ + 1))) - ((SJdownH*beta0*(alpha^(1/2)*g + alpha^(1/2)*(bA + gamma - alpha*(tA - 1)))*(rJ - 1) + SAdownH*alpha^(1/2)*beta0*(rA - 1)*(bJ + g + gamma + alpha*(eps - tJ + 1)))*(tA - 1))/((bA + gamma - alpha*(tA - 1))^2*(bJ + g + gamma + alpha*(eps - tJ + 1))) + ((SJupH*beta0*(alpha^(1/2)*g + alpha^(1/2)*(bA + gamma - alpha*(tA - 1)))*(rJ - 1) + SAupH*alpha^(1/2)*beta0*(rA - 1)*(bJ + g + gamma - alpha*(eps + tJ - 1)))*(tA - 1))/((bA + gamma - alpha*(tA - 1))^2*(bJ + g + gamma - alpha*(eps + tJ - 1))) + ((SJupH*beta0*(alpha^(1/2)*g + alpha^(1/2)*(bA + gamma - alpha*(tA - 1)))*(rJ - 1) + SAupH*alpha^(1/2)*beta0*(rA - 1)*(bJ + g + gamma - alpha*(eps + tJ - 1)))*(eps + tJ - 1))/((bA + gamma - alpha*(tA - 1))*(bJ + g + gamma - alpha*(eps + tJ - 1))^2) + ((SJdownH*beta0*(alpha^(1/2)*g + alpha^(1/2)*(bA + gamma - alpha*(tA - 1)))*(rJ - 1) + SAdownH*alpha^(1/2)*beta0*(rA - 1)*(bJ + g + gamma + alpha*(eps - tJ + 1)))*(eps - tJ + 1))/((bA + gamma - alpha*(tA - 1))*(bJ + g + gamma + alpha*(eps - tJ + 1))^2))/(2*eps);

% Set up the conditions for strong convergence stability. For the
% co-singular strategy to be strong convergence stable, we need the first
% condition to be positive and the others to be negative:
convstab1=(deriv2H+cderivH1)*(deriv2P+cderivP1)-cderivH2*cderivP2;
convstab2=deriv2H+cderivH1;
convstab3=deriv2P+cderivP1;

% Here are the overall conditions for evolutionary and strong convergence
% stability:
strong_convstab=convstab1>0 && convstab2<0 && convstab3<0;

host_evostab=deriv2H<0;
parasite_evostab=deriv2P<0;

deriv=JL_find_parasite_singstrat_derivative(q,f,g,bJ,bA,tA,beta0,rJ,rA,a0,c1,c2,gamma,tJ,initvec,orig_tmax);
parasite_convstab=deriv2P+cderivP1<0;
host_convstab=deriv2H+cderivH1+cderivH2*deriv<0;

if isempty(deriv)
    host_convstab=strong_convstab;
end

% Define outputs:
if host_evostab && host_convstab && strong_convstab
    classH=1;
elseif ~host_evostab && ~host_convstab && ~strong_convstab
    classH=2;
elseif ~host_evostab && host_convstab && strong_convstab
    classH=3;
elseif host_evostab && ~host_convstab && ~strong_convstab
    classH=2;
elseif host_evostab
    classH=4;
elseif ~host_evostab
    classH=5;
end
if parasite_evostab && parasite_convstab && strong_convstab
    classP=1;
elseif ~parasite_evostab && ~parasite_convstab && ~strong_convstab
    classP=2;
elseif ~parasite_evostab && parasite_convstab && strong_convstab
    classP=3;
elseif parasite_evostab && ~parasite_convstab && ~strong_convstab
    classP=2;
elseif parasite_evostab
    classP=4;
elseif ~parasite_evostab
    classP=5;
end


end
